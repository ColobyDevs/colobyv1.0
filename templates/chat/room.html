{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block base %}
    <h2>{{ name }}</h2>
    <p>Room Code: {{ slug }}</p>

    <h3>Tasks:</h3>
    <ul>
        {% for task in tasks %}
            <li>
                <strong>Title:</strong> {{ task.title }}<br>
                <strong>Description:</strong> {{ task.description }}<br>
                <strong>Due Date:</strong> {{ task.due_date }}<br>
                <strong>Assigned To:</strong> {{ task.assigned_to.username }}<br>
                <strong>Completed:</strong> {% if task.completed %}Yes{% else %}No{% endif %}
            </li>

{% comment %} 
            {% if task.completed %}
            <span class="completed-task">✔</span>
        {% else %}
            <span class="incomplete-task">□</span>
        {% endif %} {% endcomment %}

        {% endfor %}
    </ul>
    


  


<H1> CHATS BELOW:</H1>


    <div id="chat-messages">
        {% regroup messages by created_at|date:"F j, Y" as message_groups %}
        {% for group in message_groups %}
            <div class="message-group">
                <br>
                <div class="date-header">{{ group.grouper }}</div>
                <br>
                {% for message in group.list %}
                    <div class="message">
                        <span class="username">{{ message.user.username }}:</span>
                        <span class="content">{{ message.message }}</span>
                        <span class="time">{{ message.created_at|naturaltime }}</span>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    
    <div hx-target="this" hx-swap="outerHTML" ws-connect="/chat/{{ slug }}/">
     
        <form hx-post="." ws-send>
            {% csrf_token %}
            
            <input name="message" placeholder="Type your message..." autocomplete="off">
            
            <button type="submit">Send</button>
        </form>
    </div>
    

<script>
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/chat/{{ slug }}/'
    );

    const notificationSound = new Audio('{% static 'notify.wav' %}');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.textContent = `${data.username}: ${data.message}`;
        messagesDiv.appendChild(messageElement);
        // Automatically scroll to the bottom to show the latest message
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Play notification sound
        if (document.visibilityState !== 'visible') {
            playNotificationSound();
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        const messageInput = document.querySelector('input[name="message"]');
        const message = messageInput.value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    });

    function playNotificationSound() {
        // Play the notification sound
        notificationSound.play();
    }

    // Refresh the chat periodically
    const refreshInterval = 5000; // 5 seconds
    setInterval(refreshChat, refreshInterval);


//timeout for inactivity

        let inactivityTimeout;
    
        function resetInactivityTimeout() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(redirectToHomePage, 300000); // 5 minutes (300000 milliseconds)
        }
    
        function redirectToHomePage() {
            window.location.href = '/'; // Change this to your home page URL
        }
    
        // Reset the inactivity timeout whenever there's user activity
        document.addEventListener('mousemove', resetInactivityTimeout);
        document.addEventListener('keydown', resetInactivityTimeout);
        document.addEventListener('click', resetInactivityTimeout);
        
        // Initialize the inactivity timeout when the page loads
        resetInactivityTimeout();

    

</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    
   {% endblock %}
   



